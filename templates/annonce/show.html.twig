{% extends '../user_profile/base.html.twig' %}

{% block title %}{{ annonce.titre }}{% endblock %}

{% block body %}
    <div class="max-w-7xl mx-auto mt-10 px-4">

        <div class="bg-white rounded-xl shadow-lg overflow-hidden grid grid-cols-1 md:grid-cols-12 gap-6">
            {# ----- Image principale ----- #}
            <div class="relative md:col-span-5 rounded-lg overflow-hidden h-40 sm:h-48 md:h-56 lg:h-64">
                {% set mainPhoto = null %}
                {% for photo in annonce.photos %}
                    {% if mainPhoto is null and photo.isMain %}
                        {% set mainPhoto = photo %}
                    {% endif %}
                {% endfor %}
                {# Fallback: si aucune isMain, prendre la 1ère photo #}
                {% if mainPhoto is null and annonce.photos|length > 0 %}
                    {% set mainPhoto = annonce.photos|first %}
                {% endif %}

                {% if mainPhoto %}
                    {% set mainPath = asset('uploads/photos/' ~ mainPhoto.filename) %}
                    <a href="{{ mainPath }}" class="block w-full h-full" data-lightbox>
                        <img src="{{ mainPath }}"
                             alt="Photo principale"
                             class="absolute inset-0 w-full h-full object-cover cursor-zoom-in">
                    </a>
                {% else %}
                    <div class="absolute inset-0 bg-gray-200 flex items-center justify-center text-gray-500">
                        Aucune image
                    </div>
                {% endif %}
            </div>

            {# ----- Détails ----- #}
            <div class="md:col-span-7 p-6 md:p-8 flex flex-col justify-center bg-white">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ annonce.titre }}</h1>

                <div class="mb-2">
                <span class="inline-block px-3 py-1 rounded-full text-sm font-medium
                    {% if annonce.status == 'Disponible' %}
                        bg-green-100 text-green-800
                    {% elseif annonce.status == 'Réservé' %}
                        bg-yellow-100 text-yellow-800
                    {% elseif annonce.status == 'Troc effectué' %}
                        bg-gray-200 text-gray-700
                    {% else %}
                        bg-gray-100 text-gray-600
                    {% endif %}
                ">
                    {# si status est un enum/string, adapte si besoin #}
                    {{ annonce.status.value is defined ? annonce.status.value : annonce.status }}
                </span>
                </div>

                <p class="text-gray-700 mb-4">{{ annonce.description }}</p>

                <p class="text-sm text-gray-500 mb-2">
                    Posté le {{ annonce.createdAt|date('d/m/Y à H:i') }}
                </p>

                <p class="text-sm text-gray-600 mb-6">
                    Proposé par :
                    <a href="{{ path('user_profile', { id: annonce.user.id }) }}"
                       class="text-blue-600 hover:underline">
                        {{ annonce.user.username }}
                    </a>
                </p>

                {% if app.user != annonce.user %}
                    <div class="flex gap-4">
                        <a href="{{ path('app_message_index', { id: annonce.id }) }}"
                           class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-6 rounded-lg transition">
                            Contacter
                        </a>

                        <a href="{{ path('reservation_new', {id: annonce.id}) }}"
                           class="inline-block bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-6 rounded-lg transition">
                            Réserver
                        </a>
                    </div>
                {% endif %}

                {# ----- Galerie ----- #}
                {% set galleryPhotos = [] %}
                {% for photo in annonce.photos %}
                    {% if not photo.isMain %}
                        {% set galleryPhotos = galleryPhotos|merge([photo]) %}
                    {% endif %}
                {% endfor %}

                {% if galleryPhotos is not empty %}
                    <div class="mt-8">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">Galerie</h2>

                        {# “côte à côte” : flex + wrap, vignettes cliquables #}
                        <div class="flex flex-wrap gap-3">
                            {% for photo in galleryPhotos %}
                                {% set p = asset('uploads/photos/' ~ photo.filename) %}
                                <a href="{{ p }}" data-lightbox
                                   class="block rounded overflow-hidden shadow w-24 h-24 sm:w-28 sm:h-28 md:w-32 md:h-32">
                                    <img
                                        src="{{ p }}"
                                        alt="Photo de l'annonce"
                                        class="w-full h-full object-cover cursor-zoom-in"
                                    >
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        {# ----- Localisation ----- #}
        <div class="mt-10 bg-gray-50 p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Localisation</h2>

            <p class="text-gray-700 mb-4">
                Ville : <strong>{{ annonce.ville }}</strong>
            </p>

            <div class="w-full rounded overflow-hidden h-32 sm:h-40 md:h-44">
                <iframe
                    class="w-full h-full"
                    frameborder="0"
                    style="border:0"
                    referrerpolicy="no-referrer-when-downgrade"
                    loading="lazy"
                    allowfullscreen
                    src="https://www.google.com/maps/embed/v1/place?key=VOTRE_CLE_API_GOOGLE_MAPS&q={{ annonce.ville|url_encode }}">
                </iframe>
            </div>
        </div>
    </div>

    {# ----- Mini Lightbox sans dépendances ----- #}
    <dialog id="lightboxDialog" class="backdrop:bg-black/70 p-0 rounded-lg overflow-hidden">
        <img id="lightboxImg" src="" alt="" class="max-w-[90vw] max-h-[85vh] object-contain">
    </dialog>

    <script>
        document.addEventListener('click', function (e) {
            const a = e.target.closest('a[data-lightbox]');
            if (!a) return;
            e.preventDefault();

            const dlg = document.getElementById('lightboxDialog');
            const img = document.getElementById('lightboxImg');
            img.src = a.getAttribute('href');

            if (typeof dlg.showModal === 'function') {
                dlg.showModal();
                dlg.addEventListener('click', function onClick(ev) {
                    // fermer si on clique en dehors de l'image
                    const rect = img.getBoundingClientRect();
                    if (
                        ev.clientX < rect.left || ev.clientX > rect.right ||
                        ev.clientY < rect.top || ev.clientY > rect.bottom
                    ) {
                        dlg.close();
                    }
                }, { once: true });
                document.addEventListener('keydown', function onKey(ev) {
                    if (ev.key === 'Escape') dlg.close();
                }, { once: true });
            } else {
                // fallback vieux navigateurs : ouvrir dans un nouvel onglet
                window.open(a.getAttribute('href'), '_blank', 'noopener');
            }
        });
    </script>
{% endblock %}
